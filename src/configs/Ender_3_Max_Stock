#!/bin/bash

set -e

restore_configs

export MB_VERSION=${MB_VERSION}DL

opt_set CUSTOM_MACHINE_NAME "\"Ender-3 Max ${MB_VERSION}\""

$CFGDIR/bootscreens/ender
$CFGDIR/boards/creality_v4_2_2

opt_set CUSTOM_MACHINE_NAME "\"Ender-3 Max 4.2.2\""

opt_set TEMP_SENSOR_BED "1"

opt_set DEFAULT_Kp "21.39"
opt_set DEFAULT_Ki "1.56"
opt_set DEFAULT_Kd "73.30"

opt_set DEFAULT_bedKp "162.06"
opt_set DEFAULT_bedKi "17.89"
opt_set DEFAULT_bedKd "978.75"

opt_set EXTRUDE_MAXLENGTH "500"

opt_set X_DRIVER_TYPE "TMC2208_STANDALONE"
opt_set Y_DRIVER_TYPE "TMC2208_STANDALONE"
opt_set Z_DRIVER_TYPE "TMC2208_STANDALONE"
opt_set E0_DRIVER_TYPE "TMC2208_STANDALONE"

opt_set DEFAULT_AXIS_STEPS_PER_UNIT "{ 80, 80, 400, 98 }"
opt_set DEFAULT_MAX_FEEDRATE "{ 500, 500, 5, 25 }"

opt_set DEFAULT_ACCELERATION "500"
opt_set DEFAULT_RETRACT_ACCELERATION "1000"
opt_set DEFAULT_TRAVEL_ACCELERATION "1000"

opt_set INVERT_Y_DIR "false"
opt_set INVERT_Z_DIR "true"

opt_set X_BED_SIZE "300"
opt_set Y_BED_SIZE "300"
opt_set Z_MAX_POS "340"

opt_set GRID_MAX_POINTS_X "6"
opt_set GRID_MAX_POINTS_Y "6"

opt_enable Z_SAFE_HOMING 
opt_set Z_MIN_ENDSTOP_INVERTING  "true"
opt_set Z_MIN_PROBE_ENDSTOP_INVERTING "true"
opt_set NOZZLE_TO_PROBE_OFFSET "{ 0, 0, +3.85 }"

opt_set FIL_RUNOUT_PIN "PA4"

opt_set RET6_12864_LCD "// LCD"

opt_set WATCH_TEMP_PERIOD "60" 
opt_set THERMAL_PROTECTION_BED_PERIOD "100"

opt_set PLR_ENABLED_DEFAULT "true"

opt_set SDSORT_USES_RAM "true"
opt_set SDSORT_CACHE_NAMES "true"
opt_set SDSORT_DYNAMIC_RAM "true"

opt_set SDCARD_CONNECTION "ONBOARD"

opt_set FILAMENT_CHANGE_UNLOAD_FEEDRATE "200"
opt_set FILAMENT_CHANGE_UNLOAD_LENGTH "460"
opt_set FILAMENT_CHANGE_FAST_LOAD_FEEDRATE "75"
opt_set FILAMENT_CHANGE_FAST_LOAD_LENGTH "410"
opt_set ADVANCED_PAUSE_PURGE_LENGTH "25"

opt_set X_CURRENT "800"
opt_set Y_CURRENT "800"
opt_set Z_CURRENT "800"
opt_set E0_CURRENT "800"

opt_set PREHEAT_1_TEMP_HOTEND "210"
opt_set PREHEAT_1_TEMP_BED "60"
opt_set PREHEAT_1_FAN_SPEED "0"

opt_set CHOPPER_TIMING "CHOPPER_DEFAULT_12V"

opt_enable \
	SHOW_CUSTOM_BOOTSCREEN \
	PIDTEMPBED \
	GCODE_CASE_INSENSITIVE \
	ENDSTOP_INTERRUPTS_FEATURE \
	S_CURVE_ACCELERATION \
	LCD_BED_LEVELING \
	LEVEL_BED_CORNERS \
	EEPROM_SETTINGS \
	EEPROM_AUTO_INIT \
	NOZZLE_PARK_FEATURE \
	SDSUPPORT \
	SPEAKER \
	CR10_STOCKDISPLAY \
	QUICK_HOME \
	BLTOUCH_DELAY \
	BLTOUCH_SET_5V_MODE \
	ADAPTIVE_STEP_SMOOTHING \
	LCD_INFO_MENU \
	STATUS_MESSAGE_SCROLLING \
	POWER_LOSS_RECOVERY \
	SDCARD_SORT_ALPHA \
	SCROLL_LONG_FILENAMES \
	BABYSTEPPING \
	BABYSTEP_WITHOUT_HOMING \
	DOUBLECLICK_FOR_Z_BABYSTEPPING \
	LIN_ADVANCE \
	EXPERIMENTAL_SCURVE \
	ADVANCED_PAUSE_FEATURE \
	PARK_HEAD_ON_PAUSE \
	SQUARE_WAVE_STEPPING \
	HOST_ACTION_COMMANDS \
	HOST_PROMPT_SUPPORT \
	EMERGENCY_PARSER \
	NOZZLE_AS_PROBE \
	AUTO_BED_LEVELING_BILINEAR \
	EXTRAPOLATE_BEYOND_GRID \
	SKEW_CORRECTION \
	SKEW_CORRECTION_GCODE

echo "- Configured for Ender 3 Max" >> README.md

export PLATFORMIO_ENV=STM32F103RET6_creality