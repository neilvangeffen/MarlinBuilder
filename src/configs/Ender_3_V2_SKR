#!/bin/bash

set -e

restore_configs

export MB_VERSION=${MB_VERSION}DL

opt_set CUSTOM_MACHINE_NAME "\"Ender-3 V2 ${MB_VERSION}\""

$CFGDIR/boards/skr_e3_v3

#Replace pins file.... Remove the supid error!
cp $CFGDIR/boards/pins_BTT_SKR_MINI_E3_V3_0.h Marlin/src/pins/stm32g0/pins_BTT_SKR_MINI_E3_V3_0.h

opt_set CUSTOM_MACHINE_NAME "\"Ender-3 V2 SKR\""
opt_set STRING_CONFIG_H_AUTHOR "\"(Ned, SKR-mini-E3-V3.0)\""

opt_set TEMP_SENSOR_BED "1"

opt_set DEFAULT_Kp "21.73"
opt_set DEFAULT_Ki "1.54"
opt_set DEFAULT_Kd "76.55"

opt_set DEFAULT_bedKp "41.79"
opt_set DEFAULT_bedKi "7.32"
opt_set DEFAULT_bedKd "158.93"

opt_set EXTRUDE_MAXLENGTH "500"

opt_set X_DRIVER_TYPE "TMC2209"
opt_set Y_DRIVER_TYPE "TMC2209"
opt_set Z_DRIVER_TYPE "TMC2209"
opt_set E0_DRIVER_TYPE "TMC2209"

opt_set DEFAULT_AXIS_STEPS_PER_UNIT "{ 80, 80, 400, 93 }"
opt_set DEFAULT_MAX_FEEDRATE "{ 500, 500, 5, 25 }"
opt_set DEFAULT_MAX_ACCELERATION "{ 3000, 3000, 100, 10000 }"
opt_set HOMING_FEEDRATE_MM_M "{ (40*60), (40*60), (4*60) }"

opt_set DEFAULT_ACCELERATION "500"
opt_set DEFAULT_RETRACT_ACCELERATION "1000"
opt_set DEFAULT_TRAVEL_ACCELERATION "1000"

opt_set NOZZLE_TO_PROBE_OFFSET "{ -40, -7, 0 }"

opt_set INVERT_X_DIR "true"
opt_set INVERT_Y_DIR "true"
opt_set INVERT_Z_DIR "false"
opt_set INVERT_E0_DIR "true"

opt_set X_BED_SIZE "235"
opt_set Y_BED_SIZE "235"
opt_set Z_MAX_POS "250"

opt_set GRID_MAX_POINTS_X "10"
opt_set GRID_MAX_POINTS_Y "10"

opt_set DEFAULT_LEVELING_FADE_HEIGHT "0.00"

opt_set X_CURRENT "580"
opt_set Y_CURRENT "580"
opt_set Z_CURRENT "580"
opt_set E0_CURRENT "650"

opt_set PREHEAT_1_LABEL "\"PLA\""
opt_set PREHEAT_1_TEMP_HOTEND "210"
opt_set PREHEAT_1_TEMP_BED "40"
opt_set PREHEAT_1_FAN_SPEED "64"

opt_set PREHEAT_2_LABEL "\"PLA Hot\""
opt_set PREHEAT_2_TEMP_HOTEND "225"
opt_set PREHEAT_2_TEMP_BED "60"
opt_set PREHEAT_2_FAN_SPEED "64"

opt_set NOZZLE_PARK_POINT "{ (X_MIN_POS + 10), (Y_MAX_POS - 10), 20 }"
opt_set EVENT_GCODE_SD_ABORT "\"G27\""

opt_set LCD_FEEDBACK_FREQUENCY_DURATION_MS "20"
opt_set LCD_FEEDBACK_FREQUENCY_HZ "1000"

opt_set CHOPPER_TIMING "CHOPPER_DEFAULT_24V"

opt_set CONTROLLER_FAN_PIN "PB15"
opt_set E0_AUTO_FAN_PIN "PC7"

opt_set SDSORT_USES_RAM "true"
opt_set SDSORT_CACHE_NAMES "true"
opt_set SDSORT_DYNAMIC_RAM "true"

opt_set SDCARD_CONNECTION "ONBOARD"

opt_enable LIN_ADVANCE
opt_set LIN_ADVANCE_K "0.0"

opt_enable ADVANCED_PAUSE_FEATURE
opt_set FILAMENT_CHANGE_UNLOAD_LENGTH "400"
opt_set FILAMENT_CHANGE_FAST_LOAD_LENGTH "350"

opt_set Z_HYBRID_THRESHOLD "20"

opt_enable \
	HOST_ACTION_COMMANDS \
	HOST_PAUSE_M76 \
	HOST_PROMPT_SUPPORT

opt_enable \
	DWIN_MARLINUI_PORTRAIT \
	LCD_INFO_MENU \
	LEVEL_BED_CORNERS \
	SPEAKER \
	LCD_BED_LEVELING \
	PIDTEMPBED \
	S_CURVE_ACCELERATION \
	EEPROM_SETTINGS \
	EEPROM_AUTO_INIT \
	NOZZLE_PARK_FEATURE \
	SDSUPPORT \
	ENDSTOP_INTERRUPTS_FEATURE \
	USE_CONTROLLER_FAN \
	CONTROLLER_FAN_EDITABLE \
	SDCARD_SORT_ALPHA \
	UTF_FILENAME_SUPPORT \
	LONG_FILENAME_HOST_SUPPORT \
	SCROLL_LONG_FILENAMES \
	STATUS_MESSAGE_SCROLLING \
	LCD_SET_PROGRESS_MANUALLY \
	BABYSTEPPING \
	BABYSTEP_WITHOUT_HOMING \
	BABYSTEP_ALWAYS_AVAILABLE \
	DOUBLECLICK_FOR_Z_BABYSTEPPING \
	BABYSTEP_DISPLAY_TOTAL \
	EXPERIMENTAL_SCURVE \
	EMERGENCY_PARSER \
	PARK_HEAD_ON_PAUSE \
	HOME_BEFORE_FILAMENT_CHANGE \
	FILAMENT_LOAD_UNLOAD_GCODES \
	SKEW_CORRECTION \
	SKEW_CORRECTION_GCODE \
	PRINTCOUNTER \
	GCODE_REPEAT_MARKERS \
	GCODE_CASE_INSENSITIVE \
	QUICK_HOME \
	BLTOUCH \
	BLTOUCH_DELAY \
	ADAPTIVE_STEP_SMOOTHING \
	AUTO_REPORT_POSITION \
	M114_DETAIL \
	REPORT_FAN_CHANGE \
	AUTO_BED_LEVELING_UBL \
	RESTORE_LEVELING_AFTER_G28 \
	G26_MESH_VALIDATION \
	AUTO_REPORT_SD_STATUS \
	TMC_DEBUG
	

opt_disable Z_MIN_PROBE_USES_Z_MIN_ENDSTOP_PIN

echo "- Configured for Ender 3 V2 SKR" >> README.md

export PLATFORMIO_ENV=STM32G0B1RE_btt